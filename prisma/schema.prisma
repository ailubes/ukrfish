generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrganizationRole {
  OWNER
  ADMIN
  MARKETPLACE_MANAGER
  MEMBER
}

enum UserRole {
  USER
  ADMIN
  SUPERADMIN
}

enum MembershipStatus {
  PENDING_REVIEW
  ACTIVE
  DENIED
  CANCELED
  EXPIRED
}

enum MembershipBillingCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum MembershipEventType {
  APPLIED
  APPROVED
  DENIED
  ACTIVATED
  PLAN_CHANGED
  CANCELED
  EXPIRED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELED
  VOID
}

enum InvoiceType {
  MEMBERSHIP_FEE
  ADJUSTMENT
  PENALTY
  OTHER
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  REJECTED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  BANK_TRANSFER
  CARD
  CASHLESS
  OTHER
}

enum BillingEventType {
  INVOICE_CREATED
  INVOICE_ISSUED
  INVOICE_CANCELED
  INVOICE_VOIDED
  PAYMENT_RECORDED
  PAYMENT_CONFIRMED
  PAYMENT_REJECTED
}

enum OrganizationProfileStatus {
  DRAFT
  SUBMITTED
  VERIFIED
}

enum OrganizationEntityType {
  FOP
  COMPANY
  GOVERNMENT
  SCIENTIFIC
  LAWMAKER
}

enum MarketplaceListingType {
  GOOD
  SERVICE
}

enum MarketplaceListingStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum MarketplaceArchiveReason {
  MANUAL
  BILLING_SUSPENDED
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  emailVerified DateTime?
  name          String?
  image         String?
  passwordHash  String?
  role          UserRole @default(USER)
  deletedAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  accounts            Account[]
  sessions            Session[]
  organizations       OrganizationMember[]
  memberships         Membership[]      @relation("MembershipSubjectUser")
  approvedMemberships Membership[]      @relation("MembershipApprovedBy")
  membershipEvents    MembershipEvent[] @relation("MembershipEventActor")
  invoices            Invoice[]         @relation("InvoiceSubjectUser")
  createdInvoices     Invoice[]         @relation("InvoiceCreatedBy")
  updatedInvoices     Invoice[]         @relation("InvoiceUpdatedBy")
  confirmedPayments   Payment[]         @relation("PaymentConfirmedBy")
  billingEvents       BillingEvent[]    @relation("BillingEventActor")
  approvedOrganizations Organization[]  @relation("OrganizationApprovedBy")
}

model Organization {
  id                  String                    @id @default(cuid())
  name                String
  entityType          OrganizationEntityType    @default(COMPANY)
  legalName           String?
  slug                String?                   @unique
  logoUrl             String?
  logoAlt             String?
  profileStatus       OrganizationProfileStatus @default(DRAFT)
  isPublicProfile     Boolean                   @default(false)
  isPublicContacts    Boolean                   @default(false)
  isPublicMarketplace Boolean                   @default(false)
  legalAddress        String?
  postalAddress       String?
  edrpou              String?
  vatNumber           String?
  iban                String?
  bankName            String?
  mfo                 String?
  signatoryName       String?
  signatoryPosition   String?
  contactName         String?
  contactRole         String?
  contactEmail        String?
  contactPhone        String?
  websiteUrl          String?
  facebookUrl         String?
  instagramUrl        String?
  linkedinUrl         String?
  youtubeUrl          String?
  telegramUrl         String?
  description         String?
  offersSummary       String?
  kvedCodes           String?
  approvedById        String?
  approvedAt          DateTime?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  deletedAt           DateTime?

  members     OrganizationMember[]
  memberships Membership[]
  invoices    Invoice[]
  listings    MarketplaceListing[]
  approvedBy  User?                    @relation("OrganizationApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)

  @@index([slug])
  @@index([profileStatus, isPublicProfile])
}

model OrganizationMember {
  organizationId String
  userId         String
  role           OrganizationRole @default(MEMBER)
  createdAt      DateTime         @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([organizationId, userId])
}

model MembershipPlan {
  id              String   @id @default(cuid())
  code            String   @unique
  name            String
  description     String
  monthlyPriceUah Int
  yearlyFreeMonths Int     @default(2)
  organizationUserLimit Int @default(1)
  isActive        Boolean  @default(true)
  deletedAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  features    PlanFeature[]
  memberships Membership[]
}

model Feature {
  id          String   @id @default(cuid())
  code        String   @unique
  label       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  plans PlanFeature[]
}

model PlanFeature {
  planId    String
  featureId String
  createdAt DateTime @default(now())

  plan    MembershipPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  feature Feature        @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@id([planId, featureId])
}

model Membership {
  id            String                @id @default(cuid())
  userId        String
  organizationId String?
  planId        String
  status        MembershipStatus      @default(PENDING_REVIEW)
  billingCycle  MembershipBillingCycle?
  startsAt      DateTime?
  endsAt        DateTime?
  approvedAt    DateTime?
  approvedById  String?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  user         User          @relation("MembershipSubjectUser", fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  plan         MembershipPlan @relation(fields: [planId], references: [id], onDelete: Restrict)
  approvedBy   User?          @relation("MembershipApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  events       MembershipEvent[]
  invoices     Invoice[]

  @@index([userId, status, createdAt])
  @@index([organizationId, status])
}

model MembershipEvent {
  id           String              @id @default(cuid())
  membershipId String
  actorId      String?
  type         MembershipEventType
  note         String?
  createdAt    DateTime            @default(now())

  membership Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  actor      User?      @relation("MembershipEventActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([membershipId, createdAt])
}

model Invoice {
  id             String                 @id @default(cuid())
  number         String                 @unique
  status         InvoiceStatus          @default(DRAFT)
  type           InvoiceType            @default(MEMBERSHIP_FEE)
  userId         String
  membershipId   String?
  organizationId String?
  billingCycle   MembershipBillingCycle?
  currency       String                 @default("UAH")
  amountMinor    Int
  paidMinor      Int                    @default(0)
  issuedAt       DateTime?
  dueAt          DateTime?
  paidAt         DateTime?
  note           String?
  metadata       Json?
  createdById    String?
  updatedById    String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  user         User          @relation("InvoiceSubjectUser", fields: [userId], references: [id], onDelete: Cascade)
  membership   Membership?   @relation(fields: [membershipId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  createdBy    User?         @relation("InvoiceCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy    User?         @relation("InvoiceUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  payments     Payment[]
  events       BillingEvent[]

  @@index([status, dueAt])
  @@index([userId, createdAt])
  @@index([membershipId, createdAt])
}

model Payment {
  id                String        @id @default(cuid())
  invoiceId         String
  status            PaymentStatus @default(PENDING)
  method            PaymentMethod @default(BANK_TRANSFER)
  amountMinor       Int
  currency          String        @default("UAH")
  provider          String?
  providerPaymentId String?
  payerReference    String?
  proofNote         String?
  paidAt            DateTime?
  confirmedAt       DateTime?
  confirmedById     String?
  metadata          Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  invoice     Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  confirmedBy User?          @relation("PaymentConfirmedBy", fields: [confirmedById], references: [id], onDelete: SetNull)
  events      BillingEvent[]

  @@index([invoiceId, createdAt])
  @@index([status, paidAt])
  @@unique([provider, providerPaymentId])
}

model BillingEvent {
  id        String           @id @default(cuid())
  invoiceId String?
  paymentId String?
  actorId   String?
  type      BillingEventType
  note      String?
  createdAt DateTime         @default(now())

  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  payment Payment? @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  actor   User?    @relation("BillingEventActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([invoiceId, createdAt])
  @@index([paymentId, createdAt])
  @@index([actorId, createdAt])
}

model BillingIssuerSettings {
  id                String   @id @default("default")
  legalName         String
  shortName         String
  legalAddress      String
  edrpou            String
  iban              String
  bankName          String
  mfo               String?
  vatNumber         String?
  signatoryName     String?
  signatoryPosition String?
  email             String?
  phone             String?
  website           String?
  updatedAt         DateTime @updatedAt
  createdAt         DateTime @default(now())
}

model MarketplaceListing {
  id               String                  @id @default(cuid())
  organizationId   String
  title            String
  slug             String
  type             MarketplaceListingType
  status           MarketplaceListingStatus @default(DRAFT)
  shortDescription String?
  description      String
  priceMinor       Int?
  currency         String                  @default("UAH")
  unit             String?
  minimumOrder     String?
  location         String?
  contactName      String?
  contactPhone     String?
  contactEmail     String?
  websiteUrl       String?
  coverImageUrl    String?
  isPublic         Boolean                 @default(true)
  publishedAt      DateTime?
  archivedReason   MarketplaceArchiveReason?
  lastPublicStatusBeforeSuspend MarketplaceListingStatus?
  billingSuspendedAt DateTime?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  deletedAt        DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, slug])
  @@index([status, publishedAt])
  @@index([organizationId, status])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
  @@index([userId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([sessionToken])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}
